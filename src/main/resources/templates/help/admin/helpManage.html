<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">
    <meta charset="UTF-8">
    <title>ìì£¼ë¬»ëŠ”ì§ˆë¬¸</title>
</head>
<body>
<menu th:replace="fragments/head :: menu"></menu>
<main>
    <div class="container">
        <h1 class="mb-4 text-center">ğŸ¾ ê³ ê°ì„¼í„° ê´€ë¦¬ ğŸ¾</h1>
        <h3 class="mb-4 text-center">ê³ ë¯¼ ìˆìœ¼ë©´ ì—¬ê¸°ë‹¤ ì–˜ê¸°í•˜ê°œ ğŸ¶</h3>
        <div class="row">
            <div class="list-group flex-row col-3" id="list-tab" role="tablist">
                <a class="border border-secondary list-group-item list-group-item-action active" id="getInquiryTab" data-bs-toggle="list" href="#list-home" role="tab" aria-controls="list-home">1:1ë¬¸ì˜</a>
                <a class="border border-secondary list-group-item list-group-item-action" id="getQuestionTab" data-bs-toggle="list" href="#list-profile" role="tab" aria-controls="list-profile">ìì£¼ë¬»ëŠ”ì§ˆë¬¸</a>
            </div>
        </div>

        <div class="row align-items-end" id="inquiryListDiv">

        </div>

        <div class="row align-items-end" id="questionListDiv">

        </div>
        <div id="writeModalShowDiv">
            <input type="button" class="btn btn-primary float-end" value="ì‘ì„±" data-bs-toggle="modal" data-bs-target="#writeModal"/>
        </div>
        <div>
            <table class="table table-hover" id="tableDiv">
            </table>
        </div>
        <div class="d-flex justify-content-center">
            <nav aria-label="Page navigation example">
                <ul class="pagination" id="pagination">
                </ul>
            </nav>
        </div>

    </div>

    <!-- ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ìˆ˜ì • Modal -->
    <div class="modal fade" id="updateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ì‘ì„±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <input type="hidden" id="updateQuestionNo">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="writeCategory" class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <select class="form-select form-select-sm category" id="updateCategory">
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="writeQuestion" class="form-label">ì§ˆë¬¸</label>
                        <input type="text" class="form-control" id="updateQuestion">
                    </div>
                    <div class="mb-3">
                        <label for="writeAnswer" class="form-label">ë‹µë³€</label>
                        <textarea class="form-control" id="updateAnswer" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="updateModalClose">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" id="questionUpdateBtn">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ì‘ì„± Modal -->
    <div class="modal fade" id="writeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ì‘ì„±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="writeCategory" class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <select class="form-select form-select-sm category" id="writeCategory">
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="writeQuestion" class="form-label">ì§ˆë¬¸</label>
                        <input type="text" class="form-control" id="writeQuestion">
                    </div>
                    <div class="mb-3">
                        <label for="writeAnswer" class="form-label">ë‹µë³€</label>
                        <textarea class="form-control" id="writeAnswer" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="writeModalClose">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" id="questionCreateBtn">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script src="/js/help/function.js"></script>
<script src="/js/help/page.js"></script>
<script>
    let listSwitch = 0;

    $(document).ready(function(){
        getListDiv();

        // ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ì‘ì„± ë²„íŠ¼ Click Start
        $("#questionCreateBtn").click(function(){

            let formData = new FormData();

            formData.append("helpCategoryCode", $('#writeCategory').val());
            formData.append("questionContent", $('#writeQuestion').val());
            formData.append("answerContent", $('#writeAnswer').val());

            let dataArr = [$('#writeCategory').val(), $('#writeQuestion').val(), $('#writeAnswer').val()];

            let result = handleNullInArray(dataArr);

            if (result == 0) {
                alert('ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            $.ajax({
                url : "/admin/question/write",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(result) {
                    alert(result);
                    $('#writeCategory').val('HEL-001');
                    $('#writeQuestion').val('');
                    $('#writeAnswer').val('');
                    $('#writeModalClose').click();
                    getList(1);
                }
            });
        });
        // ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ì‘ì„± ë²„íŠ¼ Click End

       // 1:1ë¬¸ì˜ íƒ­ í´ë¦­ Start
       $("#getInquiryTab").click(function(){
           listSwitch = 0;
           getListDiv();
       });
       // 1:1ë¬¸ì˜ íƒ­ í´ë¦­ End

       // ìì£¼ë¬»ëŠ”ì§ˆë¬¸ íƒ­ í´ë¦­ Start
       $("#getQuestionTab").click(function(){
           listSwitch = 1;
           getListDiv();
       });
       // ìì£¼ë¬»ëŠ”ì§ˆë¬¸ íƒ­ í´ë¦­ End
        // ê²€ìƒ‰ click ì´ë²¤íŠ¸ Start
        $(".container").on("click","#searchBtn",function(){
            getList(1);
        });
        // ê²€ìƒ‰ click ì´ë²¤íŠ¸ End
        // ê¸€ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™ Start
        $("#tableDiv").on("click",".listRow",function(){
            if (listSwitch == 0) {
                let inquiryNo = $(this).attr('data-inquiryno');
                location.href='/help/inquiry/detail?inquiryNo='+inquiryNo;
            }
        });
        // ê¸€ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™ End
        // ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ì‘ì„± ëª¨ë‹¬ Start
        $("#questionListDiv").on("click",".createModalBtn",function(){
            if (listSwitch == 1) {
                $("#writeModal").show();
            }
        });
        // ìì£¼ë¬»ëŠ”ì§ˆë¬¸ ì‘ì„± ëª¨ë‹¬ End

    });

    // ê²€ìƒ‰ í¼ ìƒì„± Start
    function getListDiv() {

        htmlStr = `
                <div class="col">
                <label for="category" class="form-label">ì¹´í…Œê³ ë¦¬</label>
                <select class="form-select" id="category">
                    <option selected value="">ì „ì²´</option>
                </select>
            </div>`;
        if (listSwitch == 0) {
            htmlStr += `
                <div class="col">
                    <label for="result" class="form-label">ê²°ê³¼</label>
                    <select class="form-select" id="result">
                        <option value="" selected>ì „ì²´</option>
                        <option value="N">ëŒ€ê¸°</option>
                        <option value="S">ì—´ëŒ</option>
                        <option value="Y">ì™„ë£Œ</option>
                    </select>
                </div>`;
        }
        htmlStr += `
            <div class="col">
                <label for="title" class="form-label">ì œëª©</label>
                <input type="text" id="title" class="form-control">
            </div>
            <div class="col">
                <br>
                <button type="button" class="btn btn-primary" id="searchBtn">ê²€ìƒ‰</button>
            </div>
        `;

        // ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° Start
        $("#writeCategory").html('');
        $("#updateCategory").html('');
        $.ajax({
            type : "GET",
            url : "/help/getCategory",
            dataType : "json",
            success : function(result) {
                for (var i = 0 ; i < result.length; i++) {
                    let htmlStr = `
                            <option value='`+result[i].helpCategoryCode+`'>`+result[i].categoryName+`</option>
                        `;
                    $('#category').append(htmlStr);
                    $('#writeCategory').append(htmlStr);
                    $('#updateCategory').append(htmlStr);
                }
            }
        });
        // ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° End

        if (listSwitch == 0) {
            $("#inquiryListDiv").html(htmlStr);
            $("#questionListDiv").html('');
            $("#writeModalShowDiv").hide();
        } else {
            $("#questionListDiv").html(htmlStr);
            $("#inquiryListDiv").html('');
            $("#writeModalShowDiv").show();
        }

        getList(1);

    }
    // ê²€ìƒ‰ í¼ ìƒì„± End

    function getList(nowPage) {

        $('#tableDiv').html('');

        // ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° Start
        if (listSwitch == 0) {
            // ì…ë ¥ í•„ë“œì™€ ì…€ë ‰íŠ¸ë°•ìŠ¤ì—ì„œ ê°’ì„ ê°€ì ¸ì˜´
            let titleValue = $('#title').val();
            let categoryValue = $('#category').val();
            let resultValue = $('#result').val();

            // ë§µê³¼ ìœ ì‚¬í•œ êµ¬ì¡°ë¡œ ë°ì´í„°ë¥¼ ìƒì„±
            let dataMap = {
                title: titleValue,
                category: categoryValue,
                result: resultValue,
                nowPage: nowPage
            };

            // ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±
            let queryString = $.param(dataMap);

            $.ajax({
                type: "GET",
                url: "/help/inquiry/getList?" + queryString,
                dataType: "json",
                success: function (result) {
                    console.log(result);
                    let template = '';
                    let resultStr = 'ëŒ€ê¸°';
                    let resultStateClass = "bg-secondary";
                    template = `
                        <thead>
                            <tr>
                                <th scope="col">ìˆœë²ˆ</th>
                                <th scope="col">ì œëª©</th>
                                <th scope="col">ìƒì„± ë‚ ì§œ</th>
                                <th scope="col">ê²°ê³¼</th>
                            </tr>
                        </thead>
                    `;
                    for (var i = 0; i < result.viewAll.length; i++) {
                        if (result.viewAll[i].result == 'S') {
                            resultStr = 'ì—´ëŒ';
                            resultStateClass = "bg-primary";
                        } else if (result.viewAll[i].result == 'Y') {
                            resultStr = 'ì™„ë£Œ';
                            resultStateClass = "bg-success";
                        } else if (result.viewAll[i].result == 'N') {
                            resultStr = 'ëŒ€ê¸°';
                            resultStateClass = "bg-secondary";
                        }
                        template += `
                            <tbody>
                                <tr class="listRow" data-inquiryNo="` + result.viewAll[i].inquiryNo + `">
                                    <td>` + result.viewAll[i].inquiryNo + `</td>
                                    <td>` + result.viewAll[i].title + `</td>
                                    <td>` + dataFormat1(result.viewAll[i].createDate) + `</td>
                                    <td><span class="badge rounded-pill ` + resultStateClass + `">` + resultStr + `</span></td>
                                </tr>
                            </tbody>
                        `;
                    }
                    getpaging(result);
                    $('#tableDiv').append(template);
                }
            });
        } else {
            // ì…ë ¥ í•„ë“œì™€ ì…€ë ‰íŠ¸ë°•ìŠ¤ì—ì„œ ê°’ì„ ê°€ì ¸ì˜´
            let titleValue = $('#title').val();
            let categoryValue = $('#category').val();

            // ë§µê³¼ ìœ ì‚¬í•œ êµ¬ì¡°ë¡œ ë°ì´í„°ë¥¼ ìƒì„±
            let dataMap = {
                title: titleValue,
                category: categoryValue,
                nowPage: nowPage
            };

            // ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±
            let queryString = $.param(dataMap);

            $.ajax({
                type: "GET",
                url: "/help/question/getList?" + queryString,
                dataType: "json",
                success: function (result) {
                    console.log(result);
                    let template = '';
                    template = `
                        <thead>
                            <tr>
                                <th scope="col">ìˆœë²ˆ</th>
                                <th scope="col">ì œëª©</th>
                                <th scope="col">ìˆ˜ì •/ì‚­ì œ</th>
                            </tr>
                        </thead>
                    `;
                    for (var i = 0; i < result.viewAll.length; i++) {
                        template += `
                            <tbody>
                                <tr class="listRow" data-question-no="` + result.viewAll[i].questionNo + `" data-question="`+result.viewAll[i].questionContent+`" data-answer="`+result.viewAll[i].answerContent+`" data-category="`+result.viewAll[i].helpCategoryCode+`">
                                    <td>` + result.viewAll[i].questionNo + `</td>
                                    <td>` + result.viewAll[i].questionContent + `</td>
                                    <td><button type="button" class="btn btn-success questionUp" data-bs-toggle="modal" data-bs-target="#updateModal">ìˆ˜ì •</button><button type="button" class="btn btn-danger questionDel">ì‚­ì œ</button></td>
                                </tr>
                            </tbody>
                        `;
                    }
                    getpaging(result);
                    $('#tableDiv').append(template);
                }
            });
        }
    }
    // ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° End

    // ìì£¼ë¬»ëŠ” ì§ˆë¬¸ ìˆ˜ì • modal On ë²„íŠ¼ Start
    $('#tableDiv').on('click','.questionUp',function(){
        let questionNo = $(this).closest('tr').data('questionNo');
        let questionContent = $(this).closest('tr').data('question');
        let answerContent = $(this).closest('tr').data('answer');
        let helpCategoryCode = $(this).closest('tr').data('category');

        $('#updateQuestionNo').val(questionNo);
        $('#updateCategory').val(helpCategoryCode);
        $('#updateQuestion').val(questionContent);
        $('#updateAnswer').val(answerContent);
    });
    // ìì£¼ë¬»ëŠ” ì§ˆë¬¸ ìˆ˜ì • modal On ë²„íŠ¼ End

    // ìì£¼ë¬»ëŠ” ì§ˆë¬¸ ìˆ˜ì • ë²„íŠ¼ Start
    $('#questionUpdateBtn').click(function(){

        let formData = new FormData();

        let questionNo = $('#updateQuestionNo').val();
        let helpCategoryCode = $('#updateCategory').val();
        let questionContent = $('#updateQuestion').val();
        let answerContent = $('#updateAnswer').val();

        let dataArr = [helpCategoryCode, questionContent, answerContent];

        let result = handleNullInArray(dataArr);

        if (result == 0) {
            alert('ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        formData.append('questionNo', questionNo);
        formData.append('helpCategoryCode', helpCategoryCode);
        formData.append('questionContent', questionContent);
        formData.append('answerContent', answerContent);

        $.ajax({
            url: "/admin/question/update",
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (result) {
                alert(result);
                $('#updateModalClose').click();
                getList(1);
            }
        });
    });
    // ìì£¼ë¬»ëŠ” ì§ˆë¬¸ ìˆ˜ì • ë²„íŠ¼ End

    // ìì£¼ë¬»ëŠ” ì§ˆë¬¸ ì‚­ì œ ë²„íŠ¼ Start
    $('#tableDiv').on('click','.questionDel',function(){

       let questionNo = $(this).closest('tr').data('questionNo');

        if (confirm("ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            $.ajax({
                url: "/admin/question/delete",
                type: 'POST',
                data: {"questionNo": questionNo},
                success: function (result) {
                    alert(result);
                    getList(1);
                }
            });
        }
    });
    // ìì£¼ë¬»ëŠ” ì§ˆë¬¸ ì‚­ì œ ë²„íŠ¼ End

</script>
</body>
</html>