<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}">
    <title>구매 상품 목록</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .table-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
    </style>
</head>

<body>
<menu th:replace="~{fragments/head :: menu}"></menu>
<main>
    <div class="container  my-5">

        <figure class="text-center">
            <h2>구매 상품 목록</h2>
        </figure>
        <div class="row">
            <div class="col-md-6">
                <h2 class="mb-4">주문/결제</h2>
                <form>
                    <div class="mb-3">
                        <label for="name" class="form-label">구매자 성함</label>
                        <input type="text" class="form-control" id="name" th:value="${memberDTO.name}" readonly required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">연락처</label>
                        <input type="text" class="form-control" id="phone" th:value="${memberDTO.tel}" readonly required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">배송지 주소</label>
                        <input type="text" class="form-control" id="address" th:value="${paymentHistory[0].address}" readonly required>
                    </div>
                    <div class="mb-3">
                        <label for="request" class="form-label">배송시 요청사항</label>
                        <input type="text" class="form-control" id="request" th:value="${paymentHistory[0].request}" readonly required>
                    </div>
                </form>
            </div>

            <div class="col-md-6">
                <div th:if="${not #lists.isEmpty(paymentHistory)}" class="card shadow">
                    <div class="card-body paymentHistory-item">
                        <div class="paymentHistory-info table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                <tr>
                                    <th>구매 상품</th>
                                    <th>결제 금액</th>
                                    <th>결제일</th>
                                    <th>배송 상태</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="paymentHistory : ${paymentHistory}" th:data-username="${paymentHistory.username}">
                                    <td>
                                        <div th:if="${salesGoodsMap[paymentHistory.goodsNo].size() > 0}" class="card-body">
                                            <img th:src="@{/images/S/{file}(file=${salesGoodsMap[paymentHistory.goodsNo][0].storedFileName})}" alt="대표 이미지" class="card-img-top" height="100">
                                        </div>
                                        <a th:href="@{/sales/selectGoods(no=${paymentHistory.goodsNo})}"
                                           th:text="${paymentHistory.productname}"
                                           class="text-decoration-none">
                                        </a>
                                    </td>
                                    <th th:text="'가격: ' + ${paymentHistory.purchaseprice} + '원'"></th>
                                    <th th:text="${#dates.format(paymentHistory.date_created, 'yyyy-MM-dd')}"></th>
                                    <th th:text="${paymentHistory.delivery_code}"></th>
                                    <th>
                                        <a th:if="${paymentHistory.delivery_code != '구매 완료' AND paymentHistory.delivery_code != '환불 대기' and paymentHistory.delivery_code != '환불 완료'}"
                                           th:href="@{/payment/paymentUpdateDelivery(payment_no=${paymentHistory.payment_no})}"
                                           class="btn btn-success">
                                            환불 신청</a>

                                        <button th:if="${paymentHistory.delivery_code == '구매 완료' and !reviewedMap[paymentHistory.goodsNo]}"
                                                type="button" class="btn btn-primary review-btn"
                                                th:data-goods-no="${paymentHistory.goodsNo}">
                                            리뷰 작성
                                        </button>

                                        <button
                                                th:if="${paymentHistory.delivery_code == '구매 완료' and reviewedMap[paymentHistory.goodsNo]}"
                                                type="button" class="btn btn-primary review-update-btn"
                                                th:data-goods-no="${paymentHistory.goodsNo}">
                                            리뷰 수정
                                        </button>


                                        <a th:if="${paymentHistory.delivery_code == '배송 완료'}"
                                           th:href="@{/payment/paymentPurchaseDelivery(payment_no=${paymentHistory.payment_no})}"
                                           class="btn btn-success">
                                            구입 확정</a>

                                    </th>
                                </tr>
                                <tr th:if="${#lists.isEmpty(paymentHistory)}">
                                    주문 정보가 없습니다.
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="paymentHistory-actions">

                        </div>
                    </div>
                </div>
            </div>

            <div class="pagination"></div>
        </div>
    </div>
</main>

<!-- 리뷰 작성 모달 -->
<div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">리뷰 작성</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="reviewForm" enctype="multipart/form-data">
                    <input type="hidden" id="goodsNo" name="goodsNo">

                    <div class="form-group">
                        <label for="starRating">별점:</label>
                        <div class="star-rating">
                            <input type="radio" id="star1" name="starRating" value="1"><label for="star1">1점</label>
                            <input type="radio" id="star2" name="starRating" value="2"><label for="star2">2점</label>
                            <input type="radio" id="star3" name="starRating" value="3"><label for="star3">3점</label>
                            <input type="radio" id="star4" name="starRating" value="4"><label for="star4">4점</label>
                            <input type="radio" id="star5" name="starRating" value="5" required><label for="star5">5점</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="imageInput">이미지 첨부:</label>
                        <input type="file" class="form-control-file" id="imageInput" multiple>
                        <div id="imgPreview" class="d-flex flex-wrap mt-2"></div>
                    </div>

                    <div class="form-group">
                        <label for="content">리뷰 내용:</label>
                        <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="submitReview">리뷰 등록</button>
            </div>
        </div>
    </div>
</div>

<!-- 리뷰 수정 모달 -->
<div class="modal fade" id="reviewUpdateModal" tabindex="-1" role="dialog" aria-labelledby="reviewUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewUpdateModalLabel">리뷰 수정</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="reviewUpdateForm" enctype="multipart/form-data">
                    <input type="hidden" id="updateGoodsNo" name="goodsNo">

                    <div class="form-group">
                        <label for="updateStarRating">별점:</label>
                        <div class="star-rating">
                            <input type="radio" id="updateStar1" name="starRating" value="1" ><label for="updateStar1">1점</label>
                            <input type="radio" id="updateStar2" name="starRating" value="2" ><label for="updateStar2">2점</label>
                            <input type="radio" id="updateStar3" name="starRating" value="3" ><label for="updateStar3">3점</label>
                            <input type="radio" id="updateStar4" name="starRating" value="4" ><label for="updateStar4">4점</label>
                            <input type="radio" id="updateStar5" name="starRating" value="5" required><label for="updateStar5">5점</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="updateImageInput">이미지 첨부:</label>
                        <input type="file" class="form-control-file" id="updateImageInput" multiple>
                        <div id="imgAddDiv" class="d-flex flex-wrap mt-2">

                        </div>
                    </div>

                    <div class="form-group">
                        <label for="updateContent">리뷰 내용:</label>
                        <textarea class="form-control" id="updateContent" name="content" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="submitUpdateReview">리뷰 수정</button>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script th:inline="javascript">

 $(document).ready(function() {
            let imageFiles = [];

            $('.review-btn').on('click', function() {
                const goodsNo = $(this).data('goods-no');
                $('#goodsNo').val(goodsNo);
                $('#reviewModal').modal('show');
            });

            $('#imageInput').on('change', function(event) {
                const files = event.target.files;
                imageFiles = [];
                $('#imgPreview').empty();

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            $('#imgPreview').append('<img src="' + e.target.result + '" alt="Selected Image" class="img-thumbnail m-1" style="width: 100px; height: 100px;">');
                        }
                        imageFiles.push(file);
                        reader.readAsDataURL(file);
                    } else {
                        alert('이미지 파일을 선택해주세요');
                    }
                }
            });

            $('#submitReview').on('click', function() {
                let formData = new FormData($('#reviewForm')[0]);

                for (let i = 0; i < imageFiles.length; i++) {
                    formData.append('imageFiles', imageFiles[i]);
                }

                $.ajax({
                    url: "/review/insertReview",
                    processData: false,
                    contentType: false,
                    type: 'POST',
                    data: formData,
                    success: function(data) {
                        alert('리뷰가 성공적으로 등록되었습니다.');
                        $('#reviewModal').modal('hide');
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('리뷰가 성공적으로 등록되었습니다.');
                        $('#reviewModal').modal('hide');
                        location.reload();
                    }
                });
            });

            $('#reviewModal').on('hidden.bs.modal', function () {
                $('#reviewForm')[0].reset();
                $('#imgPreview').empty();
                imageFiles = [];
            });
        });

$(document).ready(function() {

            let imageFiles = [];

            $('.review-update-btn').on('click', function() {
                const goodsNo = $(this).data('goods-no');
                $('#goodsNo').val(goodsNo);
                console.log(goodsNo);

                    $.ajax({
                    url : "/review/reviewUpdate",
                    type : 'GET',
                    data: { goodsNo: goodsNo },
                    success : function(result) {

                    var uploadDtos = result.uploadDtos;
                    var reviewDetails = result.reviewDetails;

                    console.log(uploadDtos);
                    console.log(reviewDetails);

                    // 별점 설정
                    $(`#updateStar${reviewDetails.starRating}`).prop('checked', true);

                    // 리뷰 내용 설정
                    $('#updateContent').val(reviewDetails.content);

                    // 기존 이미지 표시
                    $('#imgAddDiv').empty();
                    uploadDtos.forEach(function(uploadDto) {
                        $('#imgAddDiv').append(`
                            <div class="imgDiv">
                                <img src="/images/R/${uploadDto.storedFileName}" alt="..." width="100px" height="100px">
                                <input type="button" class="btn btn-danger imgDeleteBtn" data-image-no="${uploadDto.imageNo}" value="삭제">
                                <input type="button" class="btn btn-success imgUpdateBtn" data-image-no="${uploadDto.imageNo}" value="수정">
                            </div>
                        `);
                    });

                    $('#reviewUpdateModal').modal('show');
                    }
                });
            });
});




</script>

</body>
<footer th:replace="fragments/head :: footer"></footer>
</html>