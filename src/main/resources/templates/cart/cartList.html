<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">
    <style>
        .table-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
    </style>
</head>
<body>
<menu th:replace="fragments/head :: menu"></menu>
<main>
    <div class="container my-5">
        <h1 class="mb-4 text-center">장바구니</h1>
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>대표 이미지</th>
                            <th>상품명</th>
                            <th>가격</th>
                            <th>수량</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cartList : ${cartList}">
                            <td>
                                <div th:if="${cartMap[cartList.goodsNo].size() > 0}">
                                    <img th:src="@{/images/S/{file}(file=${cartMap[cartList.goodsNo][0].storedFileName})}" alt="대표 이미지" class="img-fluid" width="100" height="100">
                                </div>
                            </td>
                            <td>
                                <a th:href="@{/sales/selectGoods(no=${cartList.goodsNo})}"
                                   th:text="${cartList.goodsName}"
                                   class="text-decoration-none"></a>
                            </td>
                            <td th:text="${#numbers.formatCurrency(cartList.price)}" class="price" th:data-price="${cartList.price}"></td>
                            <td>
                                <input type="number" th:value="${cartList.purchaseQuantity}"
                                       class="form-control purchaseQuantity"
                                       min="1"
                                       th:data-goods-no="${cartList.goodsNo}"
                                       th:data-no="${cartList.no}"
                                       style="width: 70px;">
                            </td>
                            <td>
                                <a th:href="@{/cart/deleteCart(no=${cartList.no})}"
                                   class="btn btn-danger">
                                    삭제
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <div class="card mx-auto" style="width: 50%; min-width: 300px;">
                        <div class="card-body text-center">
                            <p>예상 결제 금액</p>
                            <p id="totalAmount"></p>
                            <p><a href="/payment/payment" class="btn btn-primary">결제하기</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>

$('.purchaseQuantity').change(function(){
let purchaseQuantity = $(this).val();
let no = $(this).attr('data-no');
$.ajax({
            url : "/cart/updateCart",
            type : 'POST',
            data: { purchaseQuantity : purchaseQuantity, no : no},
            success : function(data) {

            }
        });
});

// 총액을 계산하고 표시하는 함수
function updateTotalAmount() {
    let total = 0;
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const priceElement = row.querySelector('.price');
        const quantityInput = row.querySelector('.purchaseQuantity');

        if (priceElement && quantityInput) {
            const price = parseFloat(priceElement.getAttribute('data-price'));
            const quantity = parseInt(quantityInput.value);

            total += price * quantity;
        }
    });

    // 총액을 표시
    const totalAmountElement = document.getElementById('totalAmount');
    if (totalAmountElement) {
        totalAmountElement.textContent = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(total);
    }
}

// 페이지 로드 시 초기 총액 계산
document.addEventListener('DOMContentLoaded', () => {
    updateTotalAmount();

    // 수량 입력 필드에 이벤트 리스너 추가
    document.querySelectorAll('.purchaseQuantity').forEach(input => {
        input.addEventListener('change', updateTotalAmount);
    });
});
</script>



</body>
<footer th:replace="fragments/head :: footer"></footer>
</html>