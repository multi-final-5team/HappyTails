<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">
    <meta charset="UTF-8">
    <title>ì°¾ì•„ì£¼ê°œ</title>
</head>
<body>
<menu th:replace="fragments/head :: menu"></menu>
<main>
    <div class="container py-4">
        <h1 class="mb-4 text-center">ğŸ¾ ì°¾ì•„ì£¼ê°œ ğŸ¾</h1>
        <h3 class="mb-4 text-center">ìƒì–´ë²„ë¦° ë°˜ë ¤ê²¬, í•¨ê»˜ ì°¾ìŠµë‹ˆë‹¤. ğŸ¶</h3>
        <div class="card w-75 mx-auto">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="inquiryForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">ì œëª©</label>
                        <input type="text" class="form-control" name="title" id="title" th:value="${findDogDto.title}" oninput="handleOnInput(this, 30)">
                    </div>

                    <div class="form-group mb-3 w-50">
                        <label for="lostTime" class="form-label">ì‹œê°„</label>
                        <input type="datetime-local" class="form-control" name="lostTime" id="lostTime" style="width: 230px;" th:value="${findDogDto.lostTime}">
                    </div>
                    <div class="row">

                        <div class="form-group mb-3 w-25">
                            <label for="breed" class="form-label">í’ˆì¢…</label>
                            <input type="text" class="form-control" name="breed" id="breed" th:value="${findDogDto.breed}" oninput="handleOnInput(this, 15)">
                        </div>


                        <div class="form-group mb-3 w-25 ms-5">
                            <label for="breed" class="form-label">ê°•ì•„ì§€ ì´ë¦„</label>
                            <input type="text" class="form-control" name="dogName" id="dogName" th:value="${findDogDto.content}" oninput="handleOnInput(this, 15)">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">ë‚´ìš©</label>
                        <textarea class="form-control" name="content" id="content" rows="3" th:text="${findDogDto.content}"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="imageInput" class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€</label>
                        <input class="form-control" type="file" id="imageInput">
                    </div>
                    <div id="imgAddDiv">
                        <th:block th:if="${uploadDtos != null}">
                            <th:block th:each="uploadDto, iterStat : ${uploadDtos}">
                                <div class="imgDiv">
                                    <img th:src="@{/images/F/{file}(file=${uploadDto.storedFileName})}" alt="..." width="100px" height="100px">
                                    <input type="button" class="btn btn-danger imgDeleteBtn" th:data-image-no="${uploadDto.imageNo}" value="ì‚­ì œ">
                                    <input type="button" class="btn btn-success imgUpdateBtn" th:data-image-no="${uploadDto.imageNo}" value="ìˆ˜ì •">
                                </div>
                            </th:block>
                        </th:block>
                    </div>
                    <input class="form-control" type="file" id="imageUpdate" hidden="hidden">

                    <h2>ìœ„ì¹˜</h2>
                    <div class="row ms-3">
                        <div class="col-6">
                            <div class="row">
                                <div class="row">
                                    <input type="text" class="form-control mb-2" id="zipp_code_id" name="zipp_code" maxlength="10" placeholder="ìš°í¸ë²ˆí˜¸" style="width: 50%; display: inline;" hidden="hidden">
                                    <input type="button" id="zipp_btn" class="btn btn-primary col-4 mb-3" onclick="execDaumPostcode()" value="ì§€ë„ ìœ„ì¹˜ ì´ë™"><br><br>
                                    <input type="button" class="btn btn-primary col-4 mx-3 mb-3" id="myMapMove" value="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™"><br>
                                    <input type="text" class="form-control mb-2" name="user_add1" id="UserAdd1" maxlength="40" placeholder="ê¸°ë³¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" hidden="hidden" required>
                                    <input type="text" class="form-control" name="user_add2" id="UserAdd2" maxlength="40" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" hidden="hidden">
                                    <br>
                                </div>
                            </div>
                        </div>
                            <div id="map" style="width:800px;height:500px;"></div>
                    </div>
                    <br>
                    <button class="btn btn-secondary float-start" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>
                    <input type="button" class="btn btn-primary float-end" value="ê¸€ìˆ˜ì •" id="createBtn"/>

                </form>
            </div>
        </div>
    </div>
</main>
<menu th:replace="fragments/head :: footer"></menu>
<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3410cbe0e56cd0dca8e1c3bc13dec0a4&libraries=services"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="/js/help/function.js"></script>
<script>

    let latitude = 0; //ìœ„ë„
    let longitude = 0; //ê²½ë„
    let area = ''; //ì¥ì†Œ



    var addr = '';
    var geocoder = '';
    var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
        mapOption = {
            center: new kakao.maps.LatLng([[${findDogDto.latitude}]], [[${findDogDto.longitude}]]), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
            level: 1 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
        };

    // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var map = new kakao.maps.Map(mapContainer, mapOption);

    // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ì…ë‹ˆë‹¤
    var markerPosition  = new kakao.maps.LatLng([[${findDogDto.latitude}]], [[${findDogDto.longitude}]]);

    // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var marker = new kakao.maps.Marker({
        position: markerPosition
    });

    // ë§ˆì»¤ê°€ ì§€ë„ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤
    marker.setMap(map);

    // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var geocoder = new kakao.maps.services.Geocoder();

    var marker = new kakao.maps.Marker(), // í´ë¦­í•œ ìœ„ì¹˜ë¥¼ í‘œì‹œí•  ë§ˆì»¤ì…ë‹ˆë‹¤
        infowindow = new kakao.maps.InfoWindow({zindex:1}); // í´ë¦­í•œ ìœ„ì¹˜ì— ëŒ€í•œ ì£¼ì†Œë¥¼ í‘œì‹œí•  ì¸í¬ìœˆë„ìš°ì…ë‹ˆë‹¤

    // ì§€ë„ë¥¼ í´ë¦­í–ˆì„ ë•Œ í´ë¦­ ìœ„ì¹˜ ì¢Œí‘œì— ëŒ€í•œ ì£¼ì†Œì •ë³´ë¥¼ í‘œì‹œí•˜ë„ë¡ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        searchDetailAddrFromCoords(mouseEvent.latLng, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var detailAddr = !!result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;

                var content = '<div class="bAddr">' +
                    detailAddr +
                    '</div>';

                // ë§ˆì»¤ë¥¼ í´ë¦­í•œ ìœ„ì¹˜ì— í‘œì‹œí•©ë‹ˆë‹¤
                marker.setPosition(mouseEvent.latLng);
                marker.setMap(map);

                // ì¸í¬ìœˆë„ìš°ì— í´ë¦­í•œ ìœ„ì¹˜ì— ëŒ€í•œ ë²•ì •ë™ ìƒì„¸ ì£¼ì†Œì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
                infowindow.setContent(content);
                infowindow.open(map, marker);

                latitude = marker.getPosition().Ma; //ìœ„ë„
                longitude = marker.getPosition().La; //ê²½ë„
                area = detailAddr; //ì¥ì†Œ
            }
        });
    });

    function searchDetailAddrFromCoords(coords, callback) {
        // ì¢Œí‘œë¡œ ë²•ì •ë™ ìƒì„¸ ì£¼ì†Œ ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤
        geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
    }

    // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    geocoder = new kakao.maps.services.Geocoder();

    function mapMove(geocoder, addr) {
        // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
        geocoder.addressSearch(addr, function(result, status) {

            // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´
            if (status === kakao.maps.services.Status.OK) {

                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
                map.setCenter(coords);
            }
        });
    }

    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                // íŒì—…ì„ í†µí•œ ê²€ìƒ‰ ê²°ê³¼ í•­ëª© í´ë¦­ ì‹œ ì‹¤í–‰
                addr = ''; // ì£¼ì†Œ_ê²°ê³¼ê°’ì´ ì—†ì„ ê²½ìš° ê³µë°±
                var extraAddr = ''; // ì°¸ê³ í•­ëª©

                //ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
                if (data.userSelectedType === 'R') { // ë„ë¡œëª… ì£¼ì†Œë¥¼ ì„ íƒ
                    addr = data.roadAddress;
                } else { // ì§€ë²ˆ ì£¼ì†Œë¥¼ ì„ íƒ
                    addr = data.jibunAddress;
                }

                if(data.userSelectedType === 'R'){
                    if(data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if(extraAddr !== ''){
                        extraAddr = ' (' + extraAddr + ')';
                    }
                } else {
                    document.getElementById("UserAdd1").value = '';
                }

                // ì„ íƒëœ ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œ ì •ë³´ë¥¼ input ë°•ìŠ¤ì— ë„£ëŠ”ë‹¤.
                document.getElementById('zipp_code_id').value = data.zonecode;
                document.getElementById("UserAdd1").value = addr;
                document.getElementById("UserAdd1").value += extraAddr;
                document.getElementById("UserAdd2").focus(); // ìš°í¸ë²ˆí˜¸ + ì£¼ì†Œ ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŒìœ¼ë¡œ ìƒì„¸ì£¼ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™

                mapMove(geocoder,addr);
            }
        }).open();
    }

    $('#UserAdd2').keyup(function(event) {
        $("#infoMap").html($('#UserAdd2').val());
    });

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert("ì‚¬ìš©ìê°€ Geolocation ìš”ì²­ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                break;
            case error.TIMEOUT:
                alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.");
                break;
            case error.UNKNOWN_ERROR:
                alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                break;
        }
    }

    function showPosition(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        console.log("ìœ„ë„: " + latitude + "<br>ê²½ë„: " + longitude);
        var moveLatLon = new kakao.maps.LatLng(latitude,longitude);
        map.setCenter(moveLatLon);
        fetch('/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({latitude: latitude, longitude: longitude})
        }).then(response => response.text())
            .then(data => data);
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    $('#myMapMove').click(function(){
        getLocation();
    });

    // ì´ë¯¸ì§€ ë°°ì—´ ë³€ìˆ˜ Start
    let imageDeleteImageNos = [];
    let imageUpdateImageNos = [];
    let imageUpdateFiles = [];
    let imageFiles = [];
    // ì´ë¯¸ì§€ ë°°ì—´ ë³€ìˆ˜ End

    // ì´ë¯¸ì§€ road Start
    $('#imageInput').on('change', function(event) {
        var file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#imgAddDiv').append('<img src="' + e.target.result + '" alt="Selected Image" width="100px" height="100px">');
            }
            imageFiles.push(file);
            reader.readAsDataURL(file);
        } else {
            alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        }
    });
    // ì´ë¯¸ì§€ road End

    // ì´ë¯¸ì§€ ì‚­ì œë²„íŠ¼ í´ë¦­ Start
    $(".imgDiv").on("click",".imgDeleteBtn",function(){
        imageDeleteImageNos.push($(this).data("imageNo"));
        $(this).parent().remove();
    });
    // ì´ë¯¸ì§€ ì‚­ì œë²„íŠ¼ í´ë¦­ End

    // imgDiv, img, imageNoë¥¼ ì €ì¥í•  ë³€ìˆ˜ ì„ ì–¸
    let currentImgDiv;
    let currentImg;
    let currentImageNo;

    // ì—…ë°ì´íŠ¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ
    $('#imageUpdate').on('change', function(event) {
        var file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            var reader = new FileReader();
            reader.onload = function(e) {
                currentImg.attr("src", e.target.result);
            }
            reader.readAsDataURL(file);
            imageUpdateFiles.push(file);
            imageUpdateImageNos.push(currentImageNo);
            currentImgDiv.find('input').remove();
        } else {
            alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        }
    });

    // ì´ë¯¸ì§€ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„° ë°›ì•„ì˜¤ê¸°, updatefile ì—´ê¸°
    $(".imgUpdateBtn").click(function() {
        currentImageNo = $(this).data("imageNo");
        currentImgDiv = $(this).parent();
        currentImg = $(this).parent().find('img');
        $('#imageUpdate').click(); // íŒŒì¼ ì„ íƒ ì°½ì„ ì—½ë‹ˆë‹¤.
    });

    // í¼ ì„œë¸Œë°‹ Start
    let params = new URLSearchParams(location.search);
    let findDogNo = params.get('findDogNo');

    $('#createBtn').click(function(){
        let title = $('#title').val();
        let content = $('#content').val();
        let breed = $('#breed').val();
        let lostTime = $('#lostTime').val();
        let dogName = $('#dogName').val();

        let formData = new FormData();

        let dataArr = [title, content, breed, lostTime, dogName];

        let result = handleNullInArray(dataArr);

        if (result == 0) {
            alert('ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        formData.append('title',title);
        formData.append('content',content);
        formData.append('breed',breed);
        formData.append('lostTime',lostTime);
        formData.append('dogName',dogName);

        if (area != null && area != '') {
            formData.append('latitude',latitude);
            formData.append('longitude',longitude);
            formData.append('area',area);
        } else {
            formData.append('latitude','[[${findDogDto.latitude}]]');
            formData.append('longitude','[[${findDogDto.longitude}]]');
            formData.append('area','[[${findDogDto.area}]]');
        }

        formData.append('findDogNo',findDogNo);

        for (let i = 0; i < imageDeleteImageNos.length;i++) {
            formData.append('imageDeleteImageNo',imageDeleteImageNos[i]);
        }

        for (let i = 0; i < imageFiles.length;i++) {
            formData.append('imageFiles',imageFiles[i]);
        }

        for (let i = 0; i < imageUpdateFiles.length;i++) {
            formData.append('imageUpdateImageNo',imageUpdateImageNos[i]);
            formData.append('imageUpdateFiles',imageUpdateFiles[i]);
        }

        $.ajax({
            url : "/finddog/update",
            processData : false,
            contentType : false,
            type : 'POST',
            data : formData,
            success : function(result) {
                alert(result);
                location.href="/finddog/detail?findDogNo="+findDogNo;
            }
        });
    });
    // í¼ ì„œë¸Œë°‹ End

        $('#testI').click(function(){
        let lostTime = $('#lostTime').val();
        let dogName = $('#dogName').val();

        console.log(lostTime + '---' + dogName);
    });
</script>
</body>
</html>