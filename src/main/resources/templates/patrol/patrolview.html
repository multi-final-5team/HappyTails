<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">

    <title>Title</title>

</head>
<body class="container mt-5">

<menu th:replace="fragments/head :: menu"></menu>

<main>

<h1 class="mb-4">순찰대 상세</h1>

<form id="formId" method="post" enctype="multipart/form-data" >

    <div  class="mb-3" id="image_container">
        <!-- 이미지 들어가는곳 -->
    </div>

    <input class="form-control" type="file" id="inputFile" name="inputFile"><br>

    <input type="hidden" id="patrolNo" name="patrolNo">
    <input type="hidden" id="userNo" name="userNo">

    <div class="mb-3">
        <label class="form-label">강아지 이름</label><br>
        <input class="form-control" type="text" id="name" name="name"><br>
    </div>

    <div class="mb-3">
        <label class="form-label">나이</label><br>
        <input class="form-control" type="number" id="age" name="age"><br>
    </div>

    <div class="mb-3">
        <label class="form-label">품종</label><br>
        <input class="form-control" type="text" id="breed" name="breed"><br>
    </div>

    <div class="mb-3">
        <label class="form-label">주소</label><br>
        <input class="form-control" type="text" id="location" name="location"><br>
    </div>

</form>

</main>

<script th:inline="javascript">
    var username = [[${#authentication.name}]];

    $(document).ready(function() {

    var urlParams = new URL(location.href).searchParams;
    var pnum = urlParams.get('patrolNo');

    $.ajax({
    type:'get',
    url: "/patrol/findOnePatrolByPatrolNo",
    data: {parolNo : pnum},
    success : function(dto){
        data = dto.patrolDTO;
        imgs = dto.uploadDtos;

        console.log(data);
        console.log(imgs);

        $('#patrolNo').val(data.patrolNo);
        $('#userNo').val(data.userNo);
        $('#name').val(data.name);
        $('#age').val(data.age);
        $('#breed').val(data.breed);
        $('#location').val(data.location);


        if(username == data.userId){
            $('#formId').append(
            '<button class="btn btn-warning" type="button" id="formUpdateSubmitBtn" onclick="updateSubmit()">수정</button>'
            );
            $('#formId').append(
            '<button class="btn btn-danger" type="button" id="formDeleteSubmitBtn" onclick="deleteSubmit()">삭제</button>'
            );
        }




        for(let indexImg in imgs){
            $('#image_container').append(
                '<img src="/images/Z/' + imgs[indexImg].storedFileName + '">'
            );
        }

    },
    error: function (xhr){
        console.log(xhr);
    }
    }); // $.ajax()




        $('#formUpdateSubmitBtn').click(function(){

            let formData = new FormData($("#formId")[0]);

            $.ajax({
                url : "/patrol/patrolUpdate",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
        });
        // 폼 업데이트 서브밋 End

        $('#formDeleteSubmitBtn').click(function(){

            let formData = new FormData($("#formId")[0]);

            $.ajax({
                url : "/patrol/patrolDelete",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
        });
        // 폼 삭제 서브밋 End
    });

    function updateSubmit(){
        let formData = new FormData($("#formId")[0]);

            $.ajax({
                url : "/patrol/patrolUpdate",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
    }

    function deleteSubmit(){
        let formData = new FormData($("#formId")[0]);

            $.ajax({
                url : "/patrol/patrolDelete",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
    }
</script>

</body>
</html>