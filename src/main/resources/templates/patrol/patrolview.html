<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">

    <title>Title</title>

</head>

<style>
    #formId{
        width : 40%;
        margin : 3%;
    }
</style>

<body>

<menu th:replace="fragments/head :: menu"></menu>

<main>

    <div class="container mt-5">

<h1 class="mb-4 text-center">순찰대 상세</h1>

    <div class="bg-white border rounded d-flex justify-content-center">
        <form id="formId" method="post" enctype="multipart/form-data" >

            <div  class="mb-3" id="image_container">
                <!-- 이미지 들어가는곳 -->
            </div>

            <input class="form-control" type="file" id="inputFile" name="inputFile"><br>

            <input type="hidden" id="patrolNo" name="patrolNo">
            <input type="hidden" id="userNo" name="userNo">
            <input type="hidden" id="beforeImgNo" name="beforeImgNo" value="0">

            <div class="mb-3">
                <label class="form-label">강아지 이름</label><br>
                <input class="form-control" type="text" id="name" name="name" maxlength="100"><br>
            </div>

            <div class="mb-3">
                <label class="form-label">나이</label><br>
                <input class="form-control" type="number" id="age" name="age"><br>
            </div>

            <div class="mb-3">
                <label class="form-label">품종</label><br>
                <input class="form-control" type="text" id="breed" name="breed" maxlength="100"><br>
            </div>

            <div class="mb-3">
                <label class="form-label">활동지역</label><br>
                <input class="form-control" type="text" id="location" name="location" maxlength="100"><br>
            </div>

        </form>
    </div>

    </div>

</main>

<menu th:replace="fragments/head :: footer"></menu>

<script th:inline="javascript">
    var username = [[${#authentication.name}]];

    $(document).ready(function() {

    var urlParams = new URL(location.href).searchParams;
    var pnum = urlParams.get('patrolNo');

    $.ajax({
    type:'get',
    url: "/patrol/findOnePatrolByPatrolNo",
    data: {parolNo : pnum},
    success : function(dto){
        data = dto.patrolDTO;
        imgs = dto.uploadDtos;

        console.log(data);
        console.log(imgs);

        $('#patrolNo').val(data.patrolNo);
        $('#userNo').val(data.userNo);
        $('#name').val(data.name);
        $('#age').val(data.age);
        $('#breed').val(data.breed);
        $('#location').val(data.location);




        if(username == data.userId){
            $('#formId').append(
            '<button class="btn btn-warning" type="button" id="formUpdateSubmitBtn" onclick="updateSubmit()">수정</button>'
            );
            $('#formId').append(
            '<button class="btn btn-danger" type="button" id="formDeleteSubmitBtn" onclick="deleteSubmit()">삭제</button>'
            );
        }
        else{
            $("#name" ).prop('readonly', true);
            $("#age" ).prop('readonly', true);
            $("#breed" ).prop('readonly', true);
            $("#location" ).prop('readonly', true);
        }




        for(let indexImg in imgs){
            if(indexImg == 0){
                $('#image_container').append(
                    '<img src="/images/Z/' + imgs[indexImg].storedFileName + '">'
                );
                $('#beforeImgNo').val(imgs[indexImg].imageNo);
            }
        }

    },
    error: function (xhr){
        console.log(xhr);
    }
    }); // $.ajax()

    });

    // 이미지 road Start
            var imageFiles = [];
            $('#inputFile').on('change', function(event) {
            console.log('실행');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                $('#image_container').empty();
                $('#image_container').append('<img src="' + e.target.result + '" alt="Selected Image" width="100px" height="100px">');
                }
            imageFiles.push(file);
            reader.readAsDataURL(file);
            }
            else {
                alert('이미지 파일을 선택해주세요');
            }
            });
        // 이미지 road End

    function updateSubmit(){
        if(inputCheck()){
            let formData = new FormData($("#formId")[0]);

            for (let i = 0; i < imageFiles.length;i++) {
                formData.append('imageFiles',imageFiles[i]);
            }

            $.ajax({
                url : "/patrol/patrolUpdate",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
        }
    }

    function deleteSubmit(){
        let formData = new FormData($("#formId")[0]);

            $.ajax({
                url : "/patrol/patrolDelete",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
    }


    function inputCheck() {
        var input1 = $('#name').val();
        var input2 = $('#age').val();
        var input3 = $('#breed').val();
        var input4 = $('#location').val();

        if((input1 == "")||(input2 == "")||(input3 == "")||(input4 == "")){
            alert("입력칸을 모두 채워주세요.");

            return false;
        }
        else{
            if(input2.length < 11){
                return true;
            }
            else{
                alert("나이가 너무 많이 입력되었습니다. 줄여주세요.");
                $('#age').val("");
            }
        }
    }
</script>

</body>
</html>