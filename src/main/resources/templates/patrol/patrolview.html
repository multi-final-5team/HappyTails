<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">

    <title>Title</title>

</head>

<style>
    #formId{
        width : 40%;
        margin : 3%;
    }

    .image_container{
        width : 100%;
        height : 40%;
    }

    .patrolImg {
        width : 100%;
        height: 100%;
        object-fit: fill;
    }

</style>

<body>

<menu th:replace="fragments/head :: menu"></menu>

<main>

    <div class="container mt-5">

<h1 class="mb-4 text-center">순찰대 상세</h1>

    <div class="bg-white border rounded d-flex justify-content-center">
        <form id="formId" method="post" enctype="multipart/form-data" >

            <div  class="image_container" id="image_container" onclick="imgInput();">
                <!-- 이미지 들어가는곳 -->
            </div>

            <input class="" type="file" id="inputFile" name="inputFile" style="display:none;"><br>

            <input type="hidden" id="patrolNo" name="patrolNo">
            <input type="hidden" id="userNo" name="userNo">
            <input type="hidden" id="beforeImgNo" name="beforeImgNo" value="0">

            <div class="mb-3">
                <label class="form-label">강아지 이름</label><br>
                <input class="form-control" type="text" id="name" name="name" maxlength="100"><br>
            </div>

            <div class="d-flex justify-content-center">
                <div class="mb-3">
                    <label class="form-label">나이</label><br>
                    <input class="form-control" type="number" id="age" name="age"><br>
                </div>
                <div style="margin-left:auto;"></div>
                <div class="mb-3">
                    <label class="form-label">품종</label><br>
                    <input class="form-control" type="text" id="breed" name="breed" maxlength="100"><br>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">활동지역</label><br>
                <input class="form-control" type="text" id="location" name="location" maxlength="100"><br>
            </div>

        </form>
    </div>

    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0">포인트 획득 방법</h6>
        </div>
        <div class="card-body">
            <ul class="list-group list-group-flush">
                <li class="list-group-item">추천 1개 = 멍포인트 10p</li>
                <li class="list-group-item">순찰일지 1회 = 순찰 포인트 10p</li>
            </ul>
        </div>
    </div>
    <div class="card">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">랭킹 시스템</h6>
        </div>
        <div class="card-body p-0">
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary rounded-pill">신입</span>
                    <span>6600포인트 이상</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-secondary rounded-pill">치안정감</span>
                    <span>5500포인트 ~ 6600 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-success rounded-pill">치안감</span>
                    <span>4500포인트 ~ 5500 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-info rounded-pill">경무관</span>
                    <span>3600포인트 ~ 4500 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-warning rounded-pill">총경</span>
                    <span>2800포인트 ~ 3600 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-danger rounded-pill">경정</span>
                    <span>2100포인트 ~ 2800 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary rounded-pill">경감</span>
                    <span>1500포인트 ~ 2100 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-secondary rounded-pill">경위</span>
                    <span>1000포인트 ~ 1500 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-success rounded-pill">경사</span>
                    <span>600포인트 ~ 1000 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-info rounded-pill">경장</span>
                    <span>300포인트 ~ 600 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-warning rounded-pill">순경</span>
                    <span>100포인트 ~ 300 포인트</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="badge bg-danger rounded-pill">신입</span>
                    <span>0포인트 ~ 100 포인트</span>
                </li>
            </ul>
        </div>
    </div>
</main>

<menu th:replace="fragments/head :: footer"></menu>

<script th:inline="javascript">
    var username = [[${#authentication.name}]];

    $(document).ready(function() {

    var urlParams = new URL(location.href).searchParams;
    var pnum = urlParams.get('patrolNo');

    $.ajax({
    type:'get',
    url: "/patrol/findOnePatrolByPatrolNo",
    data: {parolNo : pnum},
    success : function(dto){
        data = dto.patrolDTO;
        imgs = dto.uploadDtos;

        console.log(data);
        console.log(imgs);

        $('#patrolNo').val(data.patrolNo);
        $('#userNo').val(data.userNo);
        $('#name').val(data.name);
        $('#age').val(data.age);
        $('#breed').val(data.breed);
        $('#location').val(data.location);




        if(username == data.userId){
            $('#formId').append(
            '<button class="btn btn-warning" type="button" id="formUpdateSubmitBtn" onclick="updateSubmit()">수정</button>'
            );
            $('#formId').append(
            '<button class="btn btn-danger" type="button" id="formDeleteSubmitBtn" onclick="deleteSubmit()">삭제</button>'
            );
        }
        else{
            $("#name" ).prop('readonly', true);
            $("#age" ).prop('readonly', true);
            $("#breed" ).prop('readonly', true);
            $("#location" ).prop('readonly', true);
        }




        for(let indexImg in imgs){
            if(indexImg == 0){
                $('#image_container').append(
                    '<img src="/images/Z/' + imgs[indexImg].storedFileName + '" class="patrolImg">'
                );
                $('#beforeImgNo').val(imgs[indexImg].imageNo);
            }
        }

    },
    error: function (xhr){
        console.log(xhr);
    }
    }); // $.ajax()

    });

    // 이미지 road Start
            var imageFiles = [];
            $('#inputFile').on('change', function(event) {
            console.log('실행');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                $('#image_container').empty();
                $('#image_container').append('<img src="' + e.target.result + '" onerror="this.onerror=null; this.src=\'https://kr.object.ncloudstorage.com/team-5/Non-Img.png\';" class="patrolImg">');
                }
            imageFiles.push(file);
            reader.readAsDataURL(file);
            }
            else {
                alert('이미지 파일을 선택해주세요');
            }
            });
        // 이미지 road End

    function updateSubmit(){
        if(inputCheck()){
            let formData = new FormData($("#formId")[0]);

            for (let i = 0; i < imageFiles.length;i++) {
                formData.append('imageFiles',imageFiles[i]);
            }

            $.ajax({
                url : "/patrol/patrolUpdate",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
        }
    }

    function deleteSubmit(){
        let formData = new FormData($("#formId")[0]);

            $.ajax({
                url : "/patrol/patrolDelete",
                processData : false,
                contentType : false,
                type : 'POST',
                data : formData,
                success : function(data) {
                    location.replace("/patrol/patrol");
                }
            });
    }


    function inputCheck() {
        var input1 = $('#name').val();
        var input2 = $('#age').val();
        var input3 = $('#breed').val();
        var input4 = $('#location').val();

        if((input1 == "")||(input2 == "")||(input3 == "")||(input4 == "")){
            alert("입력칸을 모두 채워주세요.");

            return false;
        }
        else{
            if(input2.length < 11){
                return true;
            }
            else{
                alert("나이가 너무 많이 입력되었습니다. 줄여주세요.");
                $('#age').val("");
            }
        }
    }

    function imgInput(){
        $('#inputFile').click();
    }
</script>

</body>
</html>