<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
                xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: head">

    <title>Title</title>

</head>

<style>
    .card{
        width: 45%;
        margin: 2.5%;
    }

    #patroldiv{
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
    }

</style>

<body>

<menu th:replace="fragments/head :: menu"></menu>

<main>

    <div class="container mt-5">



<h1 class="mb-4">순찰대 관리</h1>

    <div style="width: 30%;margin-left:auto;">
        <input class="form-control" type="text" id="searchinput">
        <button class="btn btn-info" id="btnserch" onclick="search()" style="margin-left:70%; width: 30%;">검색</button>
    </div>

<div id="patroldiv" sec:authorize="hasRole('ROLE_ADMIN')">

</div>

    <nav aria-label="Page navigation example">
        <ul class="pagination pagination-lg justify-content-center" id="pageItems">

        </ul>
    </nav>


    <script>
        var urlParams = new URL(location.href).searchParams;
        var page = urlParams.get('page');

        var pageFirst;
        var pageLast;
        var totalPages;
        var totalElements;


    $(document).ready(function(){

        $.ajax({
        type:'get',
        url: "/patrol/findAllPatrol",
        data : {
		    page : page
	    },
        success : function(dto){
            var imgs = dto.uploadDtos;
            var data = dto.list;

            console.log(data);

            pageFirst = data.first;
            pageLast = data.last;
            totalPages = data.totalPages;
            totalElements = data.totalElements;

            var contentList = data.content;

            for(let index in contentList){
                var img;
                 for(let indexImg in imgs){
                    if(imgs[indexImg].foreignNo == contentList[index].patrolNo){
                        img = imgs[indexImg].storedFileName;
                    }
                 }

                $('#patroldiv').append(

                    $('<div>').prop({
                        id: 'patrol' + index,
                        className: 'card'
                        }).attr("onclick", "gopatrol(" + contentList[index].patrolNo + ")")
                    );

                    $('#' + 'patrol' + index).append(
                        $('<div>').prop({
                            id: 'divimg' + index,
                            className: 'imgDiv'
                        })
                    );

                    $('#divimg' + index).append(
                        '<img src="/images/Z/' + img + '">'
                    );

                    $('#' + 'patrol' + index).append(
                        $('<div>').prop({
                            id: 'divbody' + index,
                            className: 'card-body'
                        })
                    );

                    $('#' + 'divbody' + index).append(
                        '<b class="card-text">강아지 이름: ' + contentList[index].name + '</b><br>'
                    );

                    $('#' + 'divbody' + index).append(
                        '<sub class="card-text">강아지 나이:' + contentList[index].age + '</sub><br>'
                    );

                    $('#' + 'divbody' + index).append(
                        '<sub class="card-text">품종:' + contentList[index].breed + '</sub>'
                    );

                    $('#' + 'patrol' + index).append(
                        $('<div>').prop({
                            id: 'divbtn' + index,
                            className: ''
                        })
                    );

                    $('#' + 'divbtn' + index).append(
                        '<button class="" id="btnDelete' + index + '" name="btnDelete' + index + '" onclick="deletepatrol(' + contentList[index].patrolNo + ')">삭제</button>'
                    );
            }

            if(page > 9){
                $('#pageItems').append(
                    '<li class="page-item"><a class="page-link" href="/admin/patrolAdmin?page=0">&#166;&laquo;</a></li>'
                );
            }

            if(!pageFirst){
                pagePrevious = Number(page) - 1;
                $('#pageItems').append(
                    '<li class="page-item"><a class="page-link" href="/admin/patrolAdmin?page=' + pagePrevious + '" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>'
                );
            }


            if(page > 9){
                pageStart = parseInt( page / 10 ) * 10;
                for(let i = pageStart; i< pageStart + 10; i++){
	                if(i < totalPages){
	                    pageNext = Number(i) + 1;
	                    if(page != i){
	                        $('#pageItems').append(
                                '<li class="page-item"><a   class="page-link"href="/admin/patrolAdmin?page=' + i +'">' + pageNext +  '</a></li>'
                            );
	                    }
	                    else{
	                        $('#pageItems').append(
                                '<li class="page-item active"><a class="page-link">' + pageNext + '</a></li>'
                            );
	                    }
	                }
                }
            }
            else{
                for(let i = 0; i<10; i++){
	                if(i < totalPages){
	                    pageNext = Number(i) + 1;
	                    if(page != i){
	                        $('#pageItems').append(
                                '<li class="page-item"><a   class="page-link"href="/admin/patrolAdmin?page=' + i +'">' + pageNext +  '</a></li>'
                            );
	                    }
	                    else{
	                        $('#pageItems').append(
                                '<li class="page-item active"><a class="page-link">' + pageNext + '</a></li>'
                            );
	                    }
	                }
                }
            }


            if(!pageLast){
                pageNext = Number(page) + 1;
                $('#pageItems').append(
                    '<li class="page-item"><a class="page-link" href="/admin/patrolAdmin?page=' + pageNext + '" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>'
                );
            }

            pageT = parseInt( page / 10 ) * 10;
            totalPagesT = parseInt( totalPages / 10 ) * 10;

            endTarget = Number(totalPagesT);

            if((totalPages > 10)&&(pageT != totalPagesT)){
                $('#pageItems').append(
                    '<li class="page-item"><a class="page-link" href="/admin/patrolAdmin?page=' + endTarget + '">&raquo;&#166;</a></li>'
                );
            }
        },
        error: function (xhr){
            console.log(xhr);
        }
        }); // $.ajax()

        $('#goPatrolInsertBtn').click(function(){
            location.href = "/patrol/patrolinsert";
        });

    });

    function gopatrolAdmin() {
             location.href = "/admin/patrolAdmin";
        }

    function deletepatrol(patrolno) {

        $.ajax({
                type:'post',
                url: "/patrol/patrolDelete",
                data: {patrolNo : patrolno},
                success : function(data){
                    gopatrolAdmin();
                },
                error: function (xhr){
                    console.log(xhr);
                }
        }); // $.ajax()
    }
    </script>

    </div>
</main>

<menu th:replace="fragments/head :: footer"></menu>

</body>
</html>