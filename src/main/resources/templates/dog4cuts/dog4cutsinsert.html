<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">

    <title>Title</title>

</head>

<style>
    .imgSquare{
        display: flex;
        flex-wrap: wrap;

        justify-content: center;
	    align-items : center;

	    gap: 1% 1%;

        background-color: black;
        width: 1000px;
        height: 600px;
    }

    .imgLine{

        display: flex;
        flex-wrap: wrap;

        justify-content: center;
        align-items: center;

        background-color: black;
        width: 400px;
        height: 800px;
    }

    .imgDivSquare{
        position : relative;
        width: 42.5%;
        height: 47.5%;
        background-color: white;
    }

    .imgDivLine{
        position : relative;
        width: 90%;
        height: 22.5%;
        background-color: white;
    }

    .cutImg{
	display:block;
	width:100%;
	height:100%;
    }

    .fileInputTotal{
        display: flex;
    }

    #captureWrap{
        position : relative;
        width: 1000px;
        overflow:auto;
    }


</style>

<body class="container mt-5">

<menu th:replace="fragments/head :: menu"></menu>

<main>

    <h1 class="mb-4">견생네컷 생성</h1>

    <div class="fileInputTotal" id="" style="margin: 3%;">
        <div class="">
            <label>이미지1</label><br>
            <input class="form-control" type="file" id="inputFile1" name="inputFile1" onchange="setThumbnail(event);" >
        </div>
        <div class="">
            <label>이미지2</label><br>
            <input class="form-control" type="file" id="inputFile2" name="inputFile2" onchange="setThumbnail(event);" >
        </div>
        <div class="">
            <label>이미지3</label><br>
            <input class="form-control" type="file" id="inputFile3" name="inputFile3" onchange="setThumbnail(event);" >
        </div>
        <div class="">
            <label>이미지4</label><br>
            <input class="form-control" type="file" id="inputFile4" name="inputFile4" onchange="setThumbnail(event);" >
        </div>
    </div>

    <label>사진배치</label>
    <select class="" id="arrangementSelect" name="">
        <option value="imgSquare" selected>네모나게</option>
        <option value="imgLine">일자로</option>
    </select>

    <label for="backgroundColorPicker">배경색 설정:</label>
    <input type="color" id="backgroundColorPicker">

    <button id="styleChangeButton" onclick="styleChange()">스타일 변경</button>

    <div class="d-flex justify-content-center" style="margin: 3%;">
        <div style="width : 100%;">
            <label>스티커 추가</label>

            <div  class="mb-3" id="image_container">
                <!-- 이미지 들어가는곳 -->
            </div>

            <input class="form-control" type="file" id="inputFile" name="inputFile" style="width : 100%;">
            <button class="" id="addStickerBtn" name="addStickerBtn" onclick="addSticker()">스티커추가</button>
        </div>

        <div style="width : 100%;">
            <label>프레임 변경</label>

            <input class="form-control" type="file" id="inputFileFrame" name="inputFileFrame" style="width : 100%;">
            <div>
                <button class="" id="addFrameBtn" name="addFrameBtn" onclick="addFrame()">프레임 변경</button>
                <button class="" id="removeFrameBtn" name="removeFrameBtn" onclick="removeFrame()">취소</button>
            </div>
        </div>
        <div style="width : 100%;">
            <label>사진 흑백필터</label><br>
            <button class="" id="grayscaleBtn" name="grayscaleBtn" onclick="addGrayscale()">사진흑백으로</button>
            <button class="" id="removeGrayscaleBtn" name="removeGrayscaleBtn" onclick="removeGrayscale()">취소</button>
        </div>
    </div>


    <div id="captureWrap">
        <div class="imgSquare" id="capture">
            <div class="imgDivSquare" id="inputFile1Div">사진1</div>
            <div class="imgDivSquare" id="inputFile2Div">사진2</div>
            <div class="imgDivSquare" id="inputFile3Div">사진3</div>
            <div class="imgDivSquare" id="inputFile4Div">사진4</div>
        </div>
    </div>

    <button id="downloadButton">다운로드</button>

    <button id="saveToServerButton">업로드</button>

</main>

<menu th:replace="fragments/head :: footer"></menu>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
    var stickerFlag = 0;
    var frameFlag = 0;
    var frameLoadFlag = 0;
    var frameSrc;

    let captureDiv = document.getElementById('capture');
    let downloadButton = document.getElementById('downloadButton');
    let saveToServerButton = document.getElementById('saveToServerButton');

    captureDiv.addEventListener('click', (e) => {

        //클릭 좌표
        console.log(e.offsetX + " , " + e.offsetY);

        console.log(e.target.nodeName.toLowerCase());
        var targetTag = e.target.nodeName.toLowerCase();

        if(stickerFlag == 1){
            x = e.offsetX - 50;
            y = e.offsetY - 50;
            var $sticker = $("#stickerImg").clone();
            $sticker.attr('class', 'stickerImg');
            $sticker.css("position", "absolute");
            $sticker.css("left", x + "px");
            $sticker.css("top", y + "px");

            if(targetTag == "img"){
                $sticker.appendTo(e.target.parentElement);
            }
            else{
                $sticker.appendTo(e.target);
            }

            stickerFlag = 0;
        }
    });

    downloadButton.addEventListener('click', () => {
        if(inputCheck()){
            html2canvas(captureDiv).then(canvas => {
            saveImg(canvas.toDataURL('image/jpg'), 'image.jpg');
            });
        }
    });

    saveToServerButton.addEventListener('click', () => {
        if(inputCheck()){

            html2canvas(captureDiv).then(canvas => {
            var imgDataUrl = canvas.toDataURL('image/jpg');

            var blobBin = atob(imgDataUrl.split(',')[1]);	// base64 데이터 디코딩
            var array = [];
            for (var i = 0; i < blobBin.length; i++) {
                array.push(blobBin.charCodeAt(i));
            }
            var file = new Blob([new Uint8Array(array)], {type: 'image/jpg'});	// Blob 생성
            const fileName = 'canvas_img_' + new Date().getMilliseconds() + '.jpg'; // 임시 파일명
            var formdata = new FormData();	// formData 생성
            formdata.append("file", file , fileName);	// file data 추가

            $.ajax({
                type : 'post',
                url : '/dog4cuts/dog4CutsInsert',
                data : formdata,
                processData : false,
                contentType : false,
                success : function (data) {

                }
            });
        });

        }
    });

    const saveImg = (uri, filename) => {
        let link = document.createElement('a');

        document.body.appendChild(link);

        link.href = uri;
        link.download = filename;
        link.click();

        document.body.removeChild(link);
    };

    //파일 선택시 표시
    function setThumbnail(eventInput) {
        let divId = eventInput.target.id + "Div";

        console.log(divId);

        console.log('실행');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {

                $('#' + divId).empty();
                $('#' + divId).append('<img src="' + e.target.result + '" alt="Selected Image" class="cutImg">');

                }
            reader.readAsDataURL(file);
            }
            else {
                alert('이미지 파일을 선택해주세요');
            }
    }

    //이미지 스타일 변경
    function styleChange() {
        $(".stickerImg").remove();


        var color = $("#backgroundColorPicker").val();
        $("#capture").css("background-color", color);

        var arrangement = $("#arrangementSelect").val();

        if(arrangement == "imgSquare"){
            $("#capture").attr('class', 'imgSquare');
            $("#capture").children().attr('class', 'imgDivSquare');
        }
        else if(arrangement == "imgLine"){
            $("#capture").attr('class', 'imgLine');
            $("#capture").children().attr('class', 'imgDivLine');
        }
    }

    function inputCheck() {
        var fileCheck1 = $('#inputFile1').val();
        var fileCheck2 = $('#inputFile2').val();
        var fileCheck3 = $('#inputFile3').val();
        var fileCheck4 = $('#inputFile4').val();
        if(!fileCheck1 || !fileCheck2 || !fileCheck3 || !fileCheck4){
            alert("파일을 첨부해 주세요");

            return false;
        }
        else{
            return true;
        }
    }

    //스티커 사진 변경
    $('#inputFile').on('change', function(event) {
            console.log('실행');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                $('#image_container').empty();
                $('#image_container').append('<img src="' + e.target.result + '" alt="Selected Image" id="stickerImg" width="100px" height="100px">');
                }
            reader.readAsDataURL(file);
            }
            else {
                alert('이미지 파일을 선택해주세요');
            }
    });

    //프레임 사진 변경
    $('#inputFileFrame').on('change', function(event) {
            console.log('실행');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {

                frameSrc = e.target.result;
                frameFlag = 1;
                }
            reader.readAsDataURL(file);
            }
            else {
                alert('이미지 파일을 선택해주세요');
            }
    });

    //스티커 플래그
    function addSticker() {
        stickerFlag = 1;
    }

    function addFrame() {
        var className = $('#capture').attr('class');

        console.log("className >> " + className);

        var frameImage = new Image();
        frameImage.src = frameSrc;

        frameImage.addEventListener('load', function() {
            frameLoadFlag = 1;
        });

        if(frameLoadFlag == 1){
            console.log(frameImage.width + " , " + frameImage.height);

            if((className == "imgSquare") && (frameImage.width > frameImage.height)){
                 $('#capture').css({'background-image':'url('+ frameSrc +')'});
            }
            else if((className == "imgLine") && (frameImage.width < frameImage.height)){
                $('#capture').css({'background-image':'url('+ frameSrc +')'});
            }
        }

    }

    function removeFrame() {

    }

    function addGrayscale() {
        $(".cutImg").css("filter", "grayscale(100%)");
    }

    function removeGrayscale() {
        $(".cutImg").css("filter", "grayscale(0)");
    }
</script>

</body>
</html>