<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">

    <title>Title</title>

</head>

<style>
    .imgSquare{
        display: flex;
        flex-wrap: wrap;

        justify-content: center;
	    align-items : center;

	    gap: 1% 1%;

        background-color: black;
        width: 1000px;
        height: 600px;
    }

    .imgSquareVertical{
        display: flex;
        flex-wrap: wrap;

        justify-content: center;
	    align-items : center;

	    gap: 2% 3%;

        background-color: black;
        width: 600px;
        height: 1000px;
    }

    .imgLine{

        display: flex;
        flex-wrap: wrap;

        justify-content: center;
        align-items: center;

        background-color: black;
        width: 400px;
        height: 800px;
    }

    .imgDivSquare{
        position : relative;
        width: 42.5%;
        height: 47.5%;
        background-color: white;
    }

    .imgDivSquareVerticalTop{
        position : relative;
        width: 42.5%;
        height: 40%;
        background-color: white;
        align-self : flex-end;
    }

    .imgDivSquareVerticalBot{
        position : relative;
        width: 42.5%;
        height: 40%;
        background-color: white;
        align-self : flex-start;
    }

    .imgDivLine{
        position : relative;
        width: 90%;
        height: 22.5%;
        background-color: white;
    }

    .cutImg{
	display:block;
	width:100%;
	height:100%;
	pointer-events : none;
    }

    .fileInputTotal{
        display: flex;
    }

    #captureWrap{
        position : relative;
        width: 1000px;
        overflow:auto;
    }


</style>

<body>

<menu th:replace="fragments/head :: menu"></menu>

<main class="container mt-5">

    <div>

        <h1 class="mb-4 text-center">ğŸê²¬ìƒë„¤ì»· ìƒì„±ğŸ“·</h1>
        <h3 class="mb-4 text-center">ğŸ¶ë°˜ë ¤ê²¬ê³¼ì˜ ì†Œì¤‘í•œ ìˆœê°„ì„ ê¾¸ë©°ë³´ì„¸ìš”ğŸ¾</h3>
        <div class="card w-75 mx-auto">
            <div class="card-body">
    <div class="fileInputTotal" id="" style="margin: 3%;">
        <div class="">
            <input class="form-control" style="display:none;" type="file" id="inputFile1" name="inputFile1" onchange="setThumbnail(event);">
        </div>
        <div class="">
            <input class="form-control" style="display:none;" type="file" id="inputFile2" name="inputFile2" onchange="setThumbnail(event);">
        </div>
        <div class="">
            <input class="form-control" style="display:none;" type="file" id="inputFile3" name="inputFile3" onchange="setThumbnail(event);">
        </div>
        <div class="">
            <input class="form-control" style="display:none;" type="file" id="inputFile4" name="inputFile4" onchange="setThumbnail(event);" >
        </div>

<!--        <div>-->
<!--            <button id="inputBtn" class="btn btn-secondary" onclick="inputChange(); this.blur();">ì´ë¯¸ì§€ ì…ë ¥</button>-->
<!--            <label id="inputLabel"></label>-->
<!--        </div>-->
    </div>




        <div class="d-flex justify-content-center">
            <div id="captureWrap">
                <div class="imgSquare" id="capture">
                    <div class="imgDivSquare" id="inputFile1Div">ì‚¬ì§„1</div>
                    <div class="imgDivSquare" id="inputFile2Div">ì‚¬ì§„2</div>
                    <div class="imgDivSquare" id="inputFile3Div">ì‚¬ì§„3</div>
                    <div class="imgDivSquare" id="inputFile4Div">ì‚¬ì§„4</div>
                </div>
            </div>
        </div>


    <div class="d-flex justify-content-center bg-white border rounded" style="margin: 3%;padding: 2%;">
        <div class="" style="width : 18%;">
            <div style="margin: 3%;">
                <div>
                    <label>ì‚¬ì§„ë°°ì¹˜</label>
                    <select class="" id="arrangementSelect" name="">
                        <option value="imgSquare" selected>ë„¤ëª¨ë‚˜ê²Œ(ê°€ë¡œ)</option>
                        <option value="imgSquareVertical">ë„¤ëª¨ë‚˜ê²Œ(ì„¸ë¡œ)</option>
                        <option value="imgLine">ì¼ìë¡œ</option>
                    </select>
                </div>

                <div>
                    <label for="backgroundColorPicker">ë°°ê²½ìƒ‰ ì„¤ì •:</label>
                    <input type="color" id="backgroundColorPicker">
                </div>
            </div>
            <button class="btn btn-light border" id="styleChangeButton" onclick="styleChange(); this.blur();" style="margin: 3%;">ìŠ¤íƒ€ì¼ ë³€ê²½</button>
            <button class="btn btn-light border" onclick="styleReset(); this.blur();" style="margin: 3%;">ê¾¸ë¯¸ê¸°ì·¨ì†Œ</button>
        </div>

        <div style="width : 30%;">
            <label>ìŠ¤í‹°ì»¤ ì¶”ê°€</label>
            <input class="form-control" type="file" id="inputFile" name="inputFile" style="width : 100%;">
            <button class="btn btn-light  border" id="addStickerBtn" name="addStickerBtn" onclick="addSticker(); this.blur();">ìŠ¤í‹°ì»¤ì¶”ê°€</button>

            <div  class="mb-3" id="image_container">
                <!-- ì´ë¯¸ì§€ ë“¤ì–´ê°€ëŠ”ê³³ -->
            </div>
        </div>

        <div style="width : 30%;">
            <label>í”„ë ˆì„ ë³€ê²½</label>

            <input class="form-control" type="file" id="inputFileFrame" name="inputFileFrame" style="width : 100%;">
            <div>
                <button class="btn btn-light  border" id="addFrameBtn" name="addFrameBtn" onclick="addFrame(); this.blur();">í”„ë ˆì„ ë³€ê²½</button>
                <button class="btn btn-light  border" id="removeFrameBtn" name="removeFrameBtn" onclick="removeFrame(); this.blur();">ì·¨ì†Œ</button>
            </div>

            <div  class="mb-3" id="frame_container">
                <!-- ì´ë¯¸ì§€ ë“¤ì–´ê°€ëŠ”ê³³ -->
            </div>
        </div>
        <div style="width : 18%;">
            <label>ì‚¬ì§„ í‘ë°±í•„í„°</label><br>
            <button class="btn btn-light  border" id="grayscaleBtn" name="grayscaleBtn" onclick="addGrayscale(); this.blur();">ì‚¬ì§„í‘ë°±ìœ¼ë¡œ</button>
            <button class="btn btn-light border" id="removeGrayscaleBtn" name="removeGrayscaleBtn" onclick="removeGrayscale(); this.blur();">ì·¨ì†Œ</button>
        </div>
    </div>


    <div class="d-flex" style="margin: 3%;">
        <div>
            <button class="btn btn-light border" id="downloadButton">ë‹¤ìš´ë¡œë“œ</button>
        </div>
        &emsp;
        <div>
            <button class="btn btn-light border" id="saveToServerButton">ì—…ë¡œë“œ</button>
        </div>

    </div>


    </div>
        </div>
    </div>
</main>

<menu th:replace="fragments/head :: footer"></menu>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>



    var stickerFlag = 0;
    var frameFlag = 0;
    var frameLoadFlag = 0;
    var frameSrc;
    var frameImage;

    var inputFlag = 0;

    var lastStiker = 0;

    let captureDiv = document.getElementById('capture');
    let downloadButton = document.getElementById('downloadButton');
    let saveToServerButton = document.getElementById('saveToServerButton');

    var className;

    $('#inputFile1Div').click(function(){
        if(stickerFlag == 0) {
            $('#inputFile1').click();
        }
    });

    $('#inputFile2Div').click(function(){
        if(stickerFlag == 0) {
            $('#inputFile2').click();
        }
    });

    $('#inputFile3Div').click(function(){
        if(stickerFlag == 0) {
            $('#inputFile3').click();
        }
    });

    $('#inputFile4Div').click(function(){
        if(stickerFlag == 0) {
            $('#inputFile4').click();
        }
    });


    captureDiv.addEventListener('click', (e) => {

        //í´ë¦­ ì¢Œí‘œ
        console.log(e.offsetX + " , " + e.offsetY);

        console.log(e.target.id);
        console.log(e.target.nodeName.toLowerCase());
        var targetTag = e.target.nodeName.toLowerCase();

        if(inputFlag == 1){
            if(e.target.id == "inputFile1Div"){
                $('#inputFile1').click();
            }
            else if(e.target.id == "inputFile2Div"){
                $('#inputFile2').click();
            }
            else if(e.target.id == "inputFile3Div"){
                $('#inputFile3').click();
            }
            else if(e.target.id == "inputFile4Div"){
                $('#inputFile4').click();
            }
        }
        else{
            if(stickerFlag == 1){
                x = e.offsetX - 50;
                y = e.offsetY - 50;
                var $sticker = $("#stickerImg" + lastStiker).clone();

                $sticker.attr('class', 'stickerImg');
                $sticker.css("position", "absolute");
                $sticker.css("left", x + "px");
                $sticker.css("top", y + "px");
                $sticker.css("z-index", "1");
                $sticker.css("pointer-events", "none"); //í´ë¦­ ì´ë²¤íŠ¸ íƒ€ê²Ÿì—ì„œ ì œì™¸

                if(targetTag == "img"){
                    $sticker.appendTo(e.target.parentElement);
                }
                else{
                    $sticker.appendTo(e.target);
                }

                stickerFlag = 0;
            }
        }
    });

    function inputChange(){
        if(inputFlag == 0){
            inputFlag = 1;
            $('#inputLabel').text("ì‚¬ì§„ ì…ë ¥ì¤‘");
        }
        else{
            inputFlag = 0;
            $('#inputLabel').text("");
        }
    }



    downloadButton.addEventListener('click', () => {
        if(inputCheck()){
            html2canvas(captureDiv).then(canvas => {
            saveImg(canvas.toDataURL('image/jpg'), 'image.jpg');
            });
        }
    });

    saveToServerButton.addEventListener('click', () => {
        if(inputCheck()){
            public = '';

            public = 'N';

            html2canvas(captureDiv).then(canvas => {
            var imgDataUrl = canvas.toDataURL('image/jpg');

            var blobBin = atob(imgDataUrl.split(',')[1]);	// base64 ë°ì´í„° ë””ì½”ë”©
            var array = [];
            for (var i = 0; i < blobBin.length; i++) {
                array.push(blobBin.charCodeAt(i));
            }
            var file = new Blob([new Uint8Array(array)], {type: 'image/jpg'});	// Blob ìƒì„±
            const fileName = 'canvas_img_' + new Date().getMilliseconds() + '.jpg'; // ì„ì‹œ íŒŒì¼ëª…
            var formdata = new FormData();	// formData ìƒì„±
            formdata.append("file", file , fileName);	// file data ì¶”ê°€
            formdata.append("publicstate", public);

            $.ajax({
                type : 'post',
                url : '/dog4cuts/dog4CutsInsert',
                data : formdata,
                processData : false,
                contentType : false,
                success : function (data) {
                    if(confirm("ì´ë¯¸ì§€ì €ì¥ì™„ë£Œ. ë§Œë“  ì´ë¯¸ì§€ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                        location.replace("/dog4cuts/dog4cutsview");
	                }else{

	                }
                }
            });
        });

        }
    });

    const saveImg = (uri, filename) => {
        let link = document.createElement('a');

        document.body.appendChild(link);

        link.href = uri;
        link.download = filename;
        link.click();

        document.body.removeChild(link);

        alert('ì´ë¯¸ì§€ ì €ì¥ì™„ë£Œ');
    };

    //íŒŒì¼ ì„ íƒì‹œ í‘œì‹œ
    function setThumbnail(eventInput) {
        let divId = eventInput.target.id + "Div";

        console.log(divId);

        console.log('ì‹¤í–‰');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {

                $('#' + divId).empty();
                $('#' + divId).append('<img src="' + e.target.result + '" alt="Selected Image" class="cutImg">');

                }
            reader.readAsDataURL(file);
            }
            else {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            }
    }

    //ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ë³€ê²½
    function styleChange() {

        $(".stickerImg").remove();


        var color = $("#backgroundColorPicker").val();
        $("#capture").css("background-color", color);

        var arrangement = $("#arrangementSelect").val();

        if(arrangement == "imgSquare"){
            $("#capture").attr('class', 'imgSquare');
            $("#capture").children().attr('class', 'imgDivSquare');
        }
        else if(arrangement == "imgLine"){
            $("#capture").attr('class', 'imgLine');
            $("#capture").children().attr('class', 'imgDivLine');
        }
        else if(arrangement == "imgSquareVertical"){
            $("#capture").attr('class', 'imgSquareVertical');
            $("#inputFile1Div").attr('class', 'imgDivSquareVerticalTop');
            $("#inputFile2Div").attr('class', 'imgDivSquareVerticalTop');
            $("#inputFile3Div").attr('class', 'imgDivSquareVerticalBot');
            $("#inputFile4Div").attr('class', 'imgDivSquareVerticalBot');
        }

        $('#capture').css({'background-image':'url()'});
        frameLoadFlag = 0;
        className = $('#capture').attr('class');

    }

    //ê¾¸ë¯¸ê¸°ì·¨ì†Œ
    function styleReset() {

        $(".stickerImg").remove();

        $(".cutImg").css("filter", "grayscale(0)");
        $('#capture').css({'background-image':'url()'});
        frameLoadFlag = 0;
        className = $('#capture').attr('class');

    }

    function inputCheck() {
        var fileCheck1 = $('#inputFile1').val();
        var fileCheck2 = $('#inputFile2').val();
        var fileCheck3 = $('#inputFile3').val();
        var fileCheck4 = $('#inputFile4').val();
        if(!fileCheck1 || !fileCheck2 || !fileCheck3 || !fileCheck4){
            alert("íŒŒì¼ì„ ì²¨ë¶€í•´ ì£¼ì„¸ìš”");

            return false;
        }
        else{
            return true;
        }
    }

    //ìŠ¤í‹°ì»¤ ì‚¬ì§„ ë³€ê²½
    $('#inputFile').on('change', function(event) {
            event.stopPropagation();
            lastStiker += 1;

            console.log('ì‹¤í–‰');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                $('#image_container').empty();
                $('#image_container').append('<img src="' + e.target.result + '" alt="Selected Image" id="stickerImg' + lastStiker + '" width="100px" height="100px">');
                }
            reader.readAsDataURL(file);
            }
            else {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            }
    });

    //í”„ë ˆì„ ì‚¬ì§„ ë³€ê²½
    $('#inputFileFrame').on('change', function(event) {
            console.log('ì‹¤í–‰');
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                $('#frame_container').empty();
                $('#frame_container').append('<img src="' + e.target.result + '" width="100px" height="100px">');

                frameSrc = e.target.result;
                frameFlag = 1;
                }
            reader.readAsDataURL(file);
            }
            else {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            }
    });

    //ìŠ¤í‹°ì»¤ í”Œë˜ê·¸
    function addSticker() {
        stickerFlag = 1;
    }

    function addFrame() {
        var frameCheck = $('#inputFileFrame').val();
         if(frameCheck){
            className = $('#capture').attr('class');

            console.log("className >> " + className);

            frameImage = new Image();
            frameImage.src = frameSrc;

            frameImage.addEventListener('load', function() {
                frameLoadFlag = 1;
            });

            if(frameLoadFlag == 1){
                console.log(frameImage.width + " , " + frameImage.height);

                $('#capture').css({'background-image':'url('+ frameSrc +')'});

            }
            else if(frameLoadFlag == 0){
                alert('ì´ë¯¸ì§€ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
            }
         }
    }

    function removeFrame() {
        $('#capture').css({'background-image':'url()'});
    }

    function addGrayscale() {
        $(".cutImg").css("filter", "grayscale(100%)");
    }

    function removeGrayscale() {
        $(".cutImg").css("filter", "grayscale(0)");
    }
</script>

</body>
</html>